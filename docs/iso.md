# 感光度（ISO）

## 何为 ISO
- ISO 的本质是增益（Gain），既可以是模拟增益，也可以是数字增益。
- 一般地，我们将仅由模拟增益确定的 ISO 称为原生 ISO（Native ISO），通过数字增益确定的 ISO 称为扩展 ISO（Extended ISO）。其中最低的原生 ISO 称为基准 ISO（Base ISO），但在如今大部分的语境中，原生 ISO 与基准 ISO 的概念通常可以混用。

## CMOS 的成像原理
- 一般地，我们将 ISO 理解为传感器对光的敏感程度。
- 光子进入 CMOS 的光电二极管中被转化为电子，并捕获到势阱（potential well）内进行积累。其中，光子到电子的转换效率被称为量子效率 $QE$，对于同一块传感器，$QE$ 已经确定，且不随 ISO 的改变而改变。对于一般的 CMOS 来说，$QE$ 通常为 0.5 ～ 0.6.
- 在 CMOS 的光电二极管上：

$$
QE = \frac{平均捕获电子数}{平均入射光子数}
$$

- 势阱内的电子被浮动扩散节点（Floating Diffusion，FD）转移并储存到浮动扩散电容 $C_{FD}$ 中。在 CMOS 的读出过程中，$C_{FD}$ 完成电荷到电势差（电压）的转换，并被源极跟随器（Source Follower，SF）读出。源极跟随器是一种共漏极电路，用做电压跟随，通常具有固定倍率。随后，该电压被可编程增益放大器（PGA）进行模拟放大后经由模数转换器（ADC）量化为数字信号。

### 基准 ISO（Base ISO）的确定
- 浮动扩散电容 $C_{FD}$ 确定了电荷到电压的转换关系，即：

$$
C_{FD} = \frac{Q}{V}
$$

其中：$Q$ 为电荷量（C），$V$ 为电压（V）。

- 单个电子所激发的电压为：$\frac{q}{C_{FD}}$，即转换增益（Conversion Gain），单位通常为 $\mu V/e^-$。在同样的量子效率和像素尺寸下，转换增益确定基准 ISO。
- 以 ILCE-1 搭载的 IMX610 为例，其在高增益下的转换增益为 $85.7\mu V/e^-$，即一个电子在浮动扩散电容上可转化为 $85.7\mu V$ 的电压。

### 原生 ISO（Native ISO）的确定
- 确定的基准 ISO 在经由源极跟随器后，由可编程增益放大器进行模拟放大，放大增益为 $n$。在相同曝光量下，输出至模数转换器的电压为 $n$ 倍的 基准 ISO。原生 ISO 由 $n ×$ 基准 ISO 确定。可编程增益放大器的放大倍率有限，以 IMX410CQK 为例，最大为 30db。

### 扩展 ISO（Expanded ISO）的确定
- 确定的原生 ISO 经由模数转换器量化为数字信号，由机内进行数字放大，取得扩展 ISO。该阶段的数字增益等同于原始图像文件（RAW Image File）文件进行后期提亮。
- 需要注意的是，部分厂家对于原生 ISO 的标定有时会包含数字放大。

## 噪声与信噪比
### 散粒噪声（Shot Noise，σS）
- 光是一种概率波，在微观尺度上，光子到达传感器某处的行为在时间和空间上都是不均匀的，呈现一定概率。一定时间内光子打到传感器后的接收数量的统计规律符合均值为 $\lambda$ 的泊松分布（Poisson Distribution），其期望 $\mu = \lambda$，方差 $\sigma^2 = \lambda$，标准差 $\sigma = \sqrt{\lambda}$。
- 在现有的技术条件下，读出噪声通常为几个电子的级别。在大多数情况下，**光的散粒噪声是噪点的第一大来源**。
- 光的散粒噪声是由于光子离散特性导致的统计涨落，是与被测信号的高低水平有关的，与传感器温度无关。

### 信噪比（Signal-to-Noise Ratio，SNR）

$$
SNR = \frac{\mu}{\sigma} = \sqrt{\lambda}
$$

- 某像素将 n 个光子转换为电子，此时散粒噪声信噪比：

$$
SNR_{shot\ noise} = \frac{n}{\sqrt{n}} = \sqrt{n}
$$

- 对于散粒噪声，当捕获电子量 n 增加，标准差（噪声）以 $\sqrt{n}$ 形式增加，信噪比也以 $\sqrt{n}$ 形式增加。因此，增加进光量可以提高信噪比。
- 对于本身光照强度低的场景，CMOS 进光量小，散粒噪声信噪比低，此时通过提高 ISO 以获得正确曝光，增益会导致图片噪点更明显。
- 噪点的原因是低进光量，不是高 ISO。不存在所谓「ISO 越高噪点越多」。

### 暗散粒噪声(Dark Current Shot Noise，σD)
- 硅片中电子的热运动会导致一些价电子随机激发至导带中形成暗电流（dark current），所以即使完全没有光子入射，传感器也会存在一定的信号输出。
- 在曝光过程中，暗电流的随机变化即形成暗散粒噪声。暗电流变化的主要原因是电子穿过 PN 结时会遇到 PN 结的电势屏障（barrier），电子穿越屏障需要经历动能-势能-动能的转换过程，所以需要耗费一些时间。
- 暗散粒噪声是由于电子的离散特性导致的统计涨落，在统计上服从泊松分布，与光信号的高低水平无关，但与传感器的温度有关，一般的规律是温度每升高 8°C 暗电流翻一倍。

### 读出噪声（Readout Noise，σR）
- 读出噪声是读出电路引入的噪声，即 CMOS 对信号的读出本身引入的噪声，其最大的来源是信号经由模数转换器量化之前的模拟电路部分。
- 读出噪声是由于电路放大或数模转换导致的统计涨落

#### 前端读出噪声
- 一般地，浮动扩散节点和源极跟随器会分别引入约 $100\mu V$ 的噪声。同时，信号传输至可编程增益放大器时也会引入传输噪声。
- 当使用高 ISO 时，可编程增益放大器对源极跟随器的读出电压添加模拟增益，导致在可编程增益放大器之前引入的所有读出噪声也被同步放大。
- 这一段随模拟增益放大而放大的读出噪声称为前端读出噪声。

#### 后端读出噪声
- 可编程增益放大器和模数转换器本身及二者的信号传输过程也会引入噪声，该部分噪声不随模拟增益的改变而改变，称为后端读出噪声。

#### 量化噪声（Quantization Noise）
- 在模数转换器中，连续变化的模拟信号采样为离散的数字信号是一个**量化**的过程。
- 数字信号的精度总是有限的，通常为 10bit 至 14bit，幅值位于两个相邻数字之间的模拟信号会四舍五入到最接近的数值，该过程一定是不完美的，引发的误差称为量化误差，引入量化噪声。
- 量化噪声在原始图像文件中的反映通常为固定的几个 bit，可以通过提高模数转换器的量化精度（bit 数）降低量化噪声。如 IMX455AQK-K 采用的 16bit 模数转换器。

### 热噪声（kT/C Noise）
- 成像过程中随着曝光时间的延长，CMOS 产热引入的噪声称为热噪声（kT/C Noise）。
- 卷帘曝光方式需要在先对势阱复位，将势阱中自由积累的电荷全部释放，为后续的读出准备。但是由于暗电流的存在，每次复位后都会残留一些大小随机的噪声信号，即复位噪声(σr)，其大小与像素结构、芯片温度、PN 结电容有关，因此也称为热噪声（kT/C Noise）。 

### 固定模式噪声（Fixed Pattern Noise，FPN）
- 由于不同像素间的空间不均匀性引入的噪声称为固定模式噪声（Fixed Pattern Noise，FPN）。固定模式噪声是固定不变的，与信号高低水平和传感器温度无关，因此可以通过标定的方法减除，在计算噪声时可忽略该项。另外，坏像素、瑕疵像素也可以视为一种固定模式噪声。
- 黑场中固定模式噪声趋同，部分摄影机可通过调整黑平衡重新标定固定模式噪声。

## 动态范围与信噪比
### 饱和阱容（Full Well Capacity）
- 像素的势阱（potential well）内达到饱和时最大能容纳的电子数量称为饱和阱容（Full Well Capacity）。
- 在浮动扩散电容中，给定允许的最大电压摆幅 $V$，可得最大电荷量：

$$
Q = V × C_{FD}
$$

- 最大电子数量（饱和阱容）：

$$
n = \frac{Q}{q} = V × C_{FD}
$$

其中：$q$ 为基本电荷量。

- 饱和阱容的精确定义是利用 PD 的饱和计算，但对于 Pinned Photodiode，一般 FD 比 PD 容值小。下文会提到双增益切换饱和阱容是依靠切换 FD 的 $C_{FD}$。

### 动态范围（Dynamic Range，DR）
- 没有信号输入时 CMOS 本身引入的噪声称为**底噪（Noise Floor）**或零输入响应，通常可以近似为读出噪声。
- 最大动态范围是最大值与最小值的比值，即饱和阱容与底噪的比值：

$$
DR_{\max} = \frac{\max}{\min} = \frac{FWC}{Noice\ Floor}
$$

- 最大动态范围通常用「档」来表示，2 倍即为 1 挡（EV），可得：

$$
DR_{\max} = \frac{\max}{\min} = \frac{FWC}{Noice\ Floor} = \log_2(\frac{FWC}{Noice\ Floor})
$$

### 最大信噪比
- 相比于散粒噪声，现代传感器的读出噪声可以忽略。通常使用 18% 的中灰，即饱和阱容的 18% 的散粒信噪比计算，最大信噪比可近似为：

$$
SNR_{\max} \approx SNR_{shot\ noise} = \frac{FWC}{\sqrt{FWC}} = \sqrt{FWC}
$$

- 以 db 表示为：

$$
SNR_{\max} \approx SNR_{shot\ noise} = \frac{FWC}{\sqrt{FWC}} = \sqrt{FWC} = 20\log_{10}\sqrt{FWC}
$$

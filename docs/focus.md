# 对焦（Focus）
## 焦点与弥散圆

- 在「[认识镜头](lens.md)」中我们提到了镜头的光学结构、焦点。

- 当与光轴平行的光线射入凸透镜并过焦点后，光线继续以锥状发散开来。在焦点前后，光线开始聚集和扩散，点的影象变成模糊的，形成一个扩大的圆，这个圆就叫做**弥散圆（circle of confusion）**。如果弥散圆的直径小于人眼的分辨能力，像在一定范围内产生的模糊是不能辨认的。这个不能辨认的弥散圆叫做**容许弥散圆(permissible circle of confusion)**。

- 凸透镜的成像规律为：

$$
\frac{1}{u} + \frac{1}{v} = \frac{1}{f}
$$

其中：$u$ 为物距，$v$ 为像距，$f$ 为焦距。

- 理想情况下，对焦的过程使得特定平面上的点光源，在经过镜头合焦后，在焦平面上被完美还原成一个点，即「绝对清晰」。

## 自动对焦（Auto Focus，AF）
- 对于机器来说，准确快速地进行对焦是一件困难的事情。早期的成像系统中，主要采取手动对焦的方式，产生了下文阐述的「手动对焦下的辅助」，他们主要是根据人眼主观判断手动进行反复调节。
- 自动对焦则将手动对焦的过程自动化，即自动进行相机镜头的镜组移动，使在传感器上成清晰的像。

### 主动式（测距式）

### 被动式

- 被动对焦主要利用透入的光线和形成的图像信息进行分析来调节焦距，主要分为**反差检测对焦（Contrast Detection Autofocus，CDAF）**和**相位检测对焦（Phase Detection Autofocus，PDAF）**。

#### 反差检测对焦

- 随着镜头向合焦位置移动，图像越来越清晰，图像的对比度也越来越大，将寻找合焦位置的焦点转化为寻找图像最大对比度的过程。
- 反差检测对焦通过计算成像中相邻像素之间的对比度来确定焦点位置。具体来说，AF算法从图像信号处理器（ISP）获取统计清晰度评价值（Focus Value，FV），并计算出镜头下一次要移动的距离和方向。
- CDAF 是一个反复迭代逐渐收敛的过程，类似于手动调焦的过程，即模糊-清晰-模糊，然后逐渐平衡到一个最清晰的位置。这一过程中，系统首先计算反差度，然后根据计算结果移动镜头、比较反差度，直到找到反差度最大的位置。
- CDAF 的聚焦点是算法任意指定的，并不对应sensor上的一些特别物理构造，因此没有数量上的限制。这使得系统可以根据图像的特征和需要灵活选择聚焦点。
- 将这个对焦点与相邻像素的对比度作分析得出右下角的曲线，失焦状态下对比度低，在聚焦过程中，曲线变得逐渐变得倾斜，但是不能判断什么时候是最高点，只有经过了对焦点后曲线下降再往回移动，反复移动后可以得到一个局部梯度最大值，就认为是对焦成功。
- 在聚焦调节范围内，每一个调焦位置会对应一个对比度值，即对焦值，这些对焦值形成一条曲线，通常称为对焦曲线，如下图1所示。评价函数往往决定了对焦效果的好坏，即图像的清晰程度。

#### 相位检测对焦

- 信号具有三大属性：幅度（Amplitude）、频率（Frequency）、相位（Phase）。

- 在初中数学中我们学过相似三角形，利用相似三角形的等比例关系，可以将水平距离转成垂直距离。

- 以平行光（无穷远点光源）为例，光圈直径为 $\text{A}$，焦距为 $\text{f}$，弥散圆直径为 $\text{CoC}$，成像平面与焦平面的距离为 $\text{h}$，存在：

$$
\frac{h}{CoC} = \frac{f}{A}
$$

- 相位差的产生同样需要左右两个PD像素。

- 在微单™相机中，人们在感光元件上预留出一些遮蔽像素点，专门用来进行相位检测。常见的方式有有单个像素遮一半（Half shield），或两个像素共用一个微透镜各自成像，有 Dual-PD、2x1微透镜相位对焦（2x1 OCL）等。

- 为了实现 PDAF 功能，shield pixel 像素被遮挡了一半，这导致像素接收到的光信号比正常的像素要弱一些，为了达到正常的像素的水平，模组厂需要对此类型的像素增加额外的增益校正，称为 SPC(Shield Pixel Calibration)。

- 图像失焦会存在相位差，PDAF 正是利用 PD 像素的相位差（phase difference）计算出离焦量（Defocus Value）完成对焦的过程。这个转换过程应用到的表单数据称为**离焦转换系数（defocus conversion coefficient，DCC）**。

- 在讨论 PDAF 功能的时候，大部分情况下我们都会声称通过该功能模组能够知道当前被摄物的距离。其实我们并非物理上知道被摄物的距离，而是通过左右 shield pixel 之间的差异来将被摄物映射到镜头移动距离中的某个位置。

!!! Note
    在传统的单镜头反光式相机中，存在独立的对焦传感器。在反光板的背面存在一个副反光板，副反光板会把从镜头入射的部分光线送到对焦传感器上，进行焦点的确定。




## 对焦模式
一般常见的对焦模式有手动对焦（MF）和自动对焦（AF-S、AF-C、AF-A）。

### 单次自动对焦（AF-S）
相机在完成一次对焦工作后立刻停止对焦并锁定焦点，不会因被摄体的移动而改变合焦区域。针对单次自动对焦的特性，它常用于拍摄相对静止的被摄体，譬如静物道具、环境风景和人物肖像等拍摄题材。

### 连续自动对焦（AF-C）
在半按快门按钮对焦时，相机会持续追踪被摄体进行对焦，焦点区域会随着被摄体的移动而改变合焦区域。经常用于体育赛事、野外生物等被摄体持续运动的题材之中。

### 自动对焦（AF-A）
在此模式下，相机会根据被摄体的运动情况自动选择 AF-C 或 AF-S 模式。被摄体处于静止状态时，相机将自动切换至 AF-S 模式；被摄体处于运动状态时，相机将自动切换至 AF-C 模式。

### 直接手动对焦（DMF）：
可以组合使用手动对焦和自动对焦，允许拍摄者在相机自动对焦下进行手动对焦微调，有助于对焦更加精准。

### 手动对焦（MF）
手动调节对焦。在部分拍摄场合，自动对焦会受到拍摄环境的限制和影响，无法顺利地工作。这时候就需要使用手动对焦进行拍摄。

!!! 注意
    - 一般采用自动对焦模式时，半按快门就可以对焦。
    - 部分镜头上具备 AF/MF 对焦模式切换开关。
    - 可更换镜头的相机系统中，有部分镜头是仅支持手动对焦，无法实现自动对焦。

## 无反相机（或单反相机的预升反光板模式）手动对焦下的辅助

实际上，由于无反相机的取景原理，它的传感器可以始终开启对焦相关功能但不实际驱动镜头对焦。因此在手动对焦模式下，仍然可以使用一些对焦辅助功能来帮助实现精准对焦。

### 放大对焦

在手动对焦模式下，可以通过放大显示屏上的画面来辅助查看对焦情况（查看是否合焦），从而实现更精准的对焦。

### 峰值显示

在手动对焦模式下，可以通过峰值显示来辅助查看对焦情况。峰值显示会在画面中对焦清晰的边缘部分进行高亮显示，从而帮助用户判断是否合焦。

### 焦点图

在手动对焦模式下，可以通过焦点图来辅助查看对焦情况。焦点图会将画面中对焦清晰的部分显示为彩色，从而帮助用户判断是否合焦。例如在 Sony 相机中，焦点图会将更靠近合焦平面的部分显示为红色，将较远离合焦平面的部分显示为蓝色。而清晰范围内的部分则无色显示。

## 单反相机（包括胶片单反）手动对焦下的辅助

由于对焦点和取景模式的限制，单反相机在手动对焦下的辅助功能没有那么灵活。另外单反对焦辅助的另一大难点是它的取景器是由反光板反射的光线直接进入人眼，由于人眼本身就有一定的调节能力，因此必须需要通过一些物理结构来辅助对焦。

**毛玻璃 菲涅尔透镜 微棱 裂像**

这四种均是会在**对焦屏**上实现的结构。对焦屏是位于反光板后方的一个半透明屏幕，光线通过反光板反射后会投射在对焦屏上，然后通过五棱镜进入取景器。

无论是以上哪一种，唯一的目的就是让对焦屏上你想合焦的部分清晰（对于微棱和裂像，则是让像完整）。

## 旁轴相机（主要是胶片旁轴）手动对焦下的辅助

旁轴相机的取景器和对焦是完全独立的两个系统。取景器通过一个小窗户看到的画面和通过镜头看到的画面并不完全一样（主要是视差问题）。

旁轴相机的对焦辅助主要是黄斑对焦。其本质是测距，只不过它的测距与镜头的对焦是联动的，可以认为是辅助估焦。

## 估焦

估焦是指通过目测距离来调节对焦。镜头的对焦环上往往表明了不同位置对焦距离。理论上已知镜头参数、对焦距离之后可以精确地计算出对焦环需要调节到什么位置。但是实际上由于无法精确测量距离，因此只能进行估测。

大疆的激光雷达模块测距实际上就是辅助估焦的。

## 对焦区域
依据不同的拍摄需求和拍摄对象，创作者往往需要在取景画面中指定特定位置或范围进行对焦，这可以通过选择相应的对焦区域模式进行实现。一般地，对焦区域选择项目有广域对焦、区域对焦、中间对焦和（扩展）自由点对焦这四种基础对焦区域。

### 广域对焦
自动对覆盖整个画面范围的被摄体对焦。在半按快门释放按钮时，会在合焦区域周围显示绿框。

### 区域对焦
在显示屏上选择想要对焦的区，相机会自动选择对焦区域。

### 中间对焦
自动对画面中央对焦。

### （扩展）自由点对焦（S/M/L）
可以将对焦框移动到画面上的所需位置并对窄小区域中的非常小的被摄体对焦。

!!! 注意
    - 当一次性完全按下快门按钮时，对焦区域可能不点亮。
    - 不同机型对「对焦区域」的注意事项或限制条件说明，请参见产品的帮助指南/产品说明书。

[^1]: Lee S Y, Kumar Y, Cho J M, et al. Enhanced autofocus algorithm using robust focus measure and fuzzy reasoning[J]. IEEE Transactions on Circuits and Systems for Video Technology, 2008, 18(9): 1237-1246.

[^2]: Ho C J, Chan C C, Chen H H. AF-Net: A convolutional neural network approach to phase detection autofocus[J]. IEEE Transactions on Image Processing, 2020, 29: 6386-6395.

[^3]: Zhang Y, Liu L, Gong W, et al. Autofocus system and evaluation methodologies: a literature review[J]. Sens. Mater., 2018, 30(5): 1165-1174.

[^4]: Xu X, Wang Y, Tang J, et al. Robust automatic focus algorithm for low contrast images using a new contrast measure[J]. Sensors, 2011, 11(9): 8281-8294.

[^5]: Krotkov E. Focusing[J]. International Journal of Computer Vision, 1988, 1(3): 223-237.
